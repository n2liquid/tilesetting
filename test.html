<!doctype html>
<meta charset="utf-8">
<img src="bof-save-map.png">
<canvas id="canvas" tile-size="16"></canvas>
<div class="tileset"></div>
<div class="tilemap"></div>
<style>
	.tileset
	{
		display: inline-block;
		width: calc(16px * 8);
		line-height: 0;
	}
	.tileset div
	{
		display: inline-block;
		width: 16px;
		height: 16px;
		background-image: -moz-element(#canvas);
	}
	.tilemap
	{
		display: inline-block;
		position: relative;
		width: 256px;
		height: 224px;
	}
	.tilemap div
	{
		position: absolute;
		display: inline-block;
		width: 16px;
		height: 16px;
		background-image: -moz-element(#canvas);
	}
</style>
<script src="https://rawgithub.com/satazor/SparkMD5/master/spark-md5.min.js"></script>
<script>
		(
			function()
			{
				var image = document.images[0];
				var canvas = document.getElementsByTagName('canvas')[0];
				var tile_size = parseInt(canvas.getAttribute('tile-size'));
				if(!tile_size)
				{
					console.error("Invalid tile size: ", tile_size);
					return;
				}
				analyze_image
				(
					image, canvas, tile_size, function(error, analysis)
					{
						if(error)
						{
							return;
						}
						make_tileset(document.getElementsByClassName('tileset')[0], analysis);
						make_tilemap(document.getElementsByClassName('tilemap')[0], analysis);
					}
				);
			}
		)();
		function analyze_image(image, canvas, tile_size, callback)
		{
			try
			{
				canvas.width = image.width;
				canvas.height = image.height;
				var context = canvas.getContext('2d');
				context.drawImage(image, 0, 0);
				var analysis =
				{
					tile_by_coordinates: {},
					tile_by_hash: {},
					tile_size: tile_size
				};
				analysis.map_width_in_tiles = canvas.width / tile_size;
				analysis.map_height_in_tiles = canvas.height / tile_size;
				function is_integer(number)
				{
					return (number % 1 === 0);
				}
				if(!is_integer(analysis.map_width_in_tiles) || !is_integer(analysis.map_height_in_tiles))
				{
					throw new Error("Map width / height must be multiples of tile size.");
				}
				var map_area_in_tiles = analysis.map_width_in_tiles * analysis.map_height_in_tiles;
				var i = 0;
				var interval = setInterval
				(
					function()
					{
						var x = i % analysis.map_width_in_tiles;
						var y = Math.floor(i / analysis.map_width_in_tiles);
						var tile_image_data = context.getImageData
						(
							x * tile_size,
							y * tile_size,
							tile_size,
							tile_size
						);
						var tile_data = tile_image_data.data;
						var tile_hash = SparkMD5.ArrayBuffer.hash(tile_data);
						console.log(x, y, tile_hash);
						analysis.tile_by_coordinates[[x, y].join('/')] = { hash: tile_hash };
						analysis.tile_by_hash[tile_hash] = { x: x, y: y };
						if(++i === map_area_in_tiles)
						{
							clearInterval(interval);
							callback(null, analysis);
						}
					},
					1
				);
			}
			catch(error)
			{
				console.error(error);
				callback(error);
			}
		}
		function make_tileset(tileset_div, analysis)
		{
			for(var hash in analysis.tile_by_hash)
			{
				var tile = analysis.tile_by_hash[hash];
				var x = (-tile.x * 16) + 'px';
				var y = (-tile.y * 16) + 'px';
				console.log(x, y, hash);
				var tile_div = document.createElement('div');
				tile_div.style = 'background-position: ' + [x, y].join(' ') + ';';
				tile_div.setAttribute('tile-hash', hash);
				tileset_div.appendChild(tile_div);
			}
		}
		function make_tilemap(tilemap_div, analysis)
		{
			for(var coords in analysis.tile_by_coordinates)
			{
				var hash = analysis.tile_by_coordinates[coords].hash;
				var tile = analysis.tile_by_hash[hash];
				var coords_array = coords.split('/');
				var x = (coords_array[0] * analysis.tile_size) + 'px';
				var y = (coords_array[1] * analysis.tile_size) + 'px';
				var sx = (-tile.x * analysis.tile_size) + 'px';
				var sy = (-tile.y * analysis.tile_size) + 'px';
				var tile_div = document.createElement('div');
				tile_div.style = 
				[
					'left: ' + x,
					'top: ' + y,
					'background-position: ' + [sx, sy].join(' ')
				].join('; ');
				tile_div.setAttribute('tile-hash', hash);
				tilemap_div.appendChild(tile_div);
			}
		}
</script>
